<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MBATHE FASHION FUSION ONLINE</title>
  <meta name="description" content="Affordable fashion â€” order via WhatsApp. Admin panel (local) included."/>
  <style>
    :root{--bg:#f6f7fb;--e:#fff;--text:#111;--muted:#5b5e6a;--accent:#ff5e62;--accent2:#f7d794;--card:#fff;--border:#e6e8f0;--shadow:0 10px 24px rgba(12,14,24,.08);--radius:12px}
    [data-theme="dark"]{--bg:#0b0b0c;--e:#121216;--text:#e8e8ea;--muted:#b9bbc6;--accent:#ff5e62;--accent2:#ffa07a;--card:#161721;--border:#24252f;--shadow:0 10px 24px rgba(0,0,0,.35)}
    [data-theme="rose"]{--bg:#0f0c15;--e:#1e1827;--text:#f7ecff;--muted:#cdbfe0;--accent:#ff6f91;--accent2:#ffc2d1;--card:#1e1827;--border:#2a2333;--shadow:0 10px 24px rgba(22,8,28,.35)}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);line-height:1.45}
    a{color:var(--accent)} a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .top{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border);background:color-mix(in oklab,var(--bg) 80%,transparent);position:sticky;top:0;z-index:50}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(120deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#fff;font-weight:700}
    .brand{font-weight:700}
    .nav{margin-left:auto;display:flex;gap:8px}
    button,select,input,textarea{font:inherit;border:1px solid var(--border);background:var(--e);color:var(--text);padding:8px 10px;border-radius:10px}
    button.primary{background:linear-gradient(120deg,var(--accent),var(--accent2));border:none;color:#1b1020;font-weight:700}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
    .pad{padding:16px}
    .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:12px}
    .product img{width:100%;height:180px;object-fit:cover;border-top-left-radius:12px;border-top-right-radius:12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    .spaced{display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px}
    dialog{border:none;padding:0;background:transparent}
    .admin-flag{background:rgba(0,0,0,.06);padding:6px 10px;border-radius:999px;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
    footer{margin-top:28px;padding:20px 0;color:var(--muted);font-size:14px}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
  </style>
</head>
<body data-theme="light">
  <header class="top wrap">
    <div class="logo" id="logo">MF</div>
    <div>
      <div class="brand">MBATHE FASHION FUSION ONLINE</div>
      <div class="muted small">Affordable â€¢ Quality â€¢ Malawi</div>
    </div>

    <nav class="nav">
      <a href="#shop"><button class="">Shop</button></a>
      <a href="#about"><button class="">About</button></a>
      <button id="btnAdmin" class="ghost">Admin</button>
      <select id="theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="rose">Rose</option>
      </select>
    </nav>
  </header>

  <main class="wrap">
    <!-- HERO -->
    <section class="hero">
      <div class="card pad">
        <h1 style="margin:0 0 8px">Best Affordable, High-Quality Fashion</h1>
        <p class="muted">Shop curated pieces. Order via WhatsApp. Admin panel stored locally (no backend).</p>
        <div style="margin-top:10px" class="row">
          <a href="#shop"><button class="primary">Shop Now</button></a>
          <a href="#contact"><button class="">Contact</button></a>
          <div style="margin-left:auto" id="adminBadge"></div>
        </div>
      </div>

      <div class="card pad">
        <h3 style="margin:0 0 8px">Featured</h3>
        <div id="featuredList" class="muted small">Loading featured...</div>
      </div>
    </section>

    <!-- SEARCH & CONTROLS -->
    <section id="shop" style="margin-top:18px">
      <div class="card pad spaced">
        <div style="flex:1">
          <input id="q" placeholder="Search products..." style="width:100%" />
        </div>
        <div class="row">
          <select id="cat">
            <option value="all">All Categories</option>
            <option>Men</option><option>Women</option><option>Kids</option><option>Accessories</option>
          </select>
          <select id="sort">
            <option value="featured">Featured</option>
            <option value="price-asc">Price â†‘</option>
            <option value="price-desc">Price â†“</option>
            <option value="new">Newest</option>
          </select>
          <button id="btnAddLocal">+ Add (Local)</button>
        </div>
      </div>

      <div id="products" class="products"></div>
    </section>

    <!-- ABOUT & CONTACT -->
    <section style="margin-top:22px" class="spaced">
      <div class="card pad" style="flex:1;margin-right:12px">
        <h3>About</h3>
        <p class="muted">MBATHE FASHION FUSION ONLINE curates quality pieces at fair prices (MWK). Order via WhatsApp for quick response and delivery.</p>
      </div>
      <div class="card pad" style="width:320px">
        <h3>Contact</h3>
        <p class="muted">Email: <a href="mailto:mbathembashu@gmail.com">mbathembashu@gmail.com</a><br>
        Phone: <a href="tel:+265996469902">+265 996 46 99 02</a></p>
        <p><a href="https://chat.whatsapp.com/HbuQsEIgjrtKrjMIxK1QUv?mode=ac_t" target="_blank">Join our WhatsApp group</a></p>
      </div>
    </section>

    <footer>
      Â© <span id="year"></span> MBATHE FASHION FUSION ONLINE â€” <span class="muted">Local admin (no server)</span>
    </footer>
  </main>

  <!-- TOAST -->
  <div id="toast" style="position:fixed;right:18px;bottom:18px;padding:10px 14px;border-radius:10px;background:#111;color:#fff;opacity:0;transition:.25s"></div>

  <!-- Admin Dialog (login / dashboard) -->
  <dialog id="adminDialog">
    <form method="dialog" style="width:min(980px,96vw);">
      <div class="card pad">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <h2 style="margin:0">Admin Panel</h2>
          <div style="margin-left:auto" id="adminControls"></div>
        </div>

        <!-- LOGIN / SET PASSWORD -->
        <div id="adminAuth" class="grid">
          <div style="margin-bottom:10px">
            <div class="muted small">First time? Set a password to protect the admin panel on this device. Password is stored hashed in localStorage.</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="adminPass" type="password" placeholder="Admin password" />
              <button id="btnSetPass" class="primary">Set / Login</button>
            </div>
          </div>
        </div>

        <!-- DASHBOARD -->
        <div id="adminDash" style="display:none">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
            <button id="btnNewProduct" class="primary">+ New Product</button>
            <button id="btnExport">Export JSON</button>
            <input id="importFile" type="file" accept=".json" style="display:none" />
            <button id="btnImport">Import JSON</button>
            <button id="btnResetSeed" style="margin-left:auto">Reset to Seed</button>
          </div>

          <div style="display:flex;gap:16px">
            <!-- Left: Products table -->
            <div style="flex:1;overflow:auto;max-height:420px">
              <table>
                <thead><tr><th>Title</th><th>Cat</th><th>Price</th><th>Feat</th><th>Actions</th></tr></thead>
                <tbody id="adminProducts"></tbody>
              </table>
            </div>

            <!-- Right: Orders -->
            <div style="width:360px">
              <h4 style="margin:0 0 8px 0">Orders</h4>
              <div style="max-height:360px;overflow:auto">
                <table><thead><tr><th>When</th><th>Item</th><th>Status</th></tr></thead><tbody id="adminOrders"></tbody></table>
              </div>
            </div>
          </div>

        </div>

      </div>
    </form>
  </dialog>

  <!-- Product Editor Dialog -->
  <dialog id="productDialog">
    <form method="dialog" class="card pad" style="min-width:480px">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <h3 id="prodTitle">New Product</h3>
        <button id="btnCloseProd" style="margin-left:auto">Close</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label>Title <input id="fTitle" /></label>
        <label>Category <select id="fCat"><option>Men</option><option>Women</option><option>Kids</option><option>Accessories</option></select></label>
        <label>Price (MWK) <input id="fPrice" type="number" /></label>
        <label>Size/Options <input id="fSize"/></label>
        <label>Notes <input id="fNotes" /></label>
        <label>Image <input id="fImage" type="file" accept="image/*" /></label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="btnSaveProd" class="primary">Save</button>
        <button id="btnDeleteProd">Delete</button>
      </div>
    </form>
  </dialog>

  <script>
  /* ---------- Utilities ---------- */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toastEl = $('#toast');
  function toast(t){ toastEl.textContent = t; toastEl.style.opacity=1; setTimeout(()=>toastEl.style.opacity=0,2200); }

  const storeKey = 'mbathe.store.v2'; // products
  const passKey = 'mbathe.admin.hash.v1';
  const ordersKey = 'mbathe.orders.v1';
  const themeKey = 'mbathe.theme.v1';

  const seed = [
      { id:'SKU-001', title:'Classic Denim Jacket', cat:'Men', price:45000, size:'S-XL', notes:'Blue | Durable stitching', img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=1600&auto=format&fit=crop', featured:true, created:Date.now()-86400000*6 },
      { id:'SKU-002', title:'Floral Summer Dress', cat:'Women', price:38000, size:'S-L', notes:'Lightweight | Flowing', img:'https://images.unsplash.com/photo-1520975940479-6c0a72b44f9f?q=80&w=1600&auto=format&fit=crop', featured:true, created:Date.now()-86400000*3 },
      { id:'SKU-003', title:'Kids Sneakers', cat:'Kids', price:22000, size:'28â€“34', notes:'Breathable | Non-slip', img:'https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1600&auto=format&fit=crop', created:Date.now()-86400000*1 },
      { id:'SKU-004', title:'Leather Crossbody Bag', cat:'Accessories', price:56000, size:'One Size', notes:'Adjustable strap', img:'https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1600&auto=format&fit=crop', created:Date.now()-86400000*10 }
  ];

  /* ---------- Storage helpers ---------- */
  function loadProducts(){ try{ return JSON.parse(localStorage.getItem(storeKey)) || seed.slice(); }catch{return seed.slice();} }
  function saveProducts(list){ localStorage.setItem(storeKey, JSON.stringify(list)); }
  function loadOrders(){ try{return JSON.parse(localStorage.getItem(ordersKey))||[] }catch{return []} }
  function saveOrders(o){ localStorage.setItem(ordersKey, JSON.stringify(o)) }

  /* ---------- Theme ---------- */
  const themeSel = $('#theme');
  function setTheme(v){ if(v==='light'){ document.body.setAttribute('data-theme','light') } else if(v==='rose'){ document.body.setAttribute('data-theme','rose') } else { document.body.setAttribute('data-theme','dark') } themeSel.value = v; localStorage.setItem(themeKey,v) }
  const storedTheme = localStorage.getItem(themeKey) || 'light'; setTheme(storedTheme);
  themeSel.addEventListener('change', e => setTheme(e.target.value));

  /* ---------- Catalog Render ---------- */
  let catalog = loadProducts();
  function money(n){ return new Intl.NumberFormat('en-MW',{style:'currency',currency:'MWK',maximumFractionDigits:0}).format(n) }

  function renderProducts(){
    const q = $('#q').value.trim().toLowerCase();
    const cat = $('#cat').value;
    const sort = $('#sort').value;
    let items = catalog.slice();

    if(cat !== 'all') items = items.filter(i=>i.cat===cat);
    if(q) items = items.filter(i=> (i.title+' '+i.cat+' '+(i.size||'')+' '+(i.notes||'')).toLowerCase().includes(q));

    if(sort==='price-asc') items.sort((a,b)=>a.price-b.price);
    else if(sort==='price-desc') items.sort((a,b)=>b.price-a.price);
    else if(sort==='new') items.sort((a,b)=>b.created - a.created);
    else items.sort((a,b)=>(b.featured?1:0)-(a.featured?1:0));

    $('#products').innerHTML = items.map(p=>`
      <div class="card">
        <img src="${p.img}" alt="${p.title}">
        <div class="pad">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${p.title}</strong>
            <span class="muted small">${p.id||''}</span>
          </div>
          <div class="muted small">${p.cat}${p.size? ' â€¢ '+p.size: ''}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div><span class="price" style="font-weight:700">${money(p.price)}</span></div>
            <div style="display:flex;gap:6px">
              <button class="primary" data-order='${encodeURIComponent(JSON.stringify(p))}'>Order on WhatsApp</button>
              <button data-quick='${encodeURIComponent(JSON.stringify(p))}'>Quick</button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    // bind action buttons
    $$('[data-order]').forEach(btn=>btn.addEventListener('click', onOrder));
    $$('[data-quick]').forEach(btn=>btn.addEventListener('click', onQuick));
    // featured short list
    const featured = catalog.filter(i=>i.featured).slice(0,3).map(i=>i.title).join(' â€¢ ');
    $('#featuredList').textContent = featured || 'No featured items right now.';
  }

  $('#q').addEventListener('input', renderProducts);
  $('#cat').addEventListener('change', renderProducts);
  $('#sort').addEventListener('change', renderProducts);

  /* ---------- Order handling (capture locally before opening WhatsApp) ---------- */
  function onOrder(e){
    const p = JSON.parse(decodeURIComponent(e.currentTarget.getAttribute('data-order')));
    const order = {
      id: 'ORD-'+Math.floor(Math.random()*900000+100000),
      when: Date.now(),
      item: { id:p.id, title:p.title, price:p.price, size:p.size || '' },
      status: 'Pending',
      notes: '',
      customerPhone: null
    };
    const orders = loadOrders();
    orders.unshift(order);
    saveOrders(orders);
    toast('Order recorded locally. Opening WhatsApp...');
    // open WhatsApp with prefilled message
    const msg = `Hello MBATHE! ðŸ‘‹%0A%0AI want to order:%0Aâ€¢ ${p.title}%0Aâ€¢ ${money(p.price)}%0A${p.size?`â€¢ Size: ${p.size}%0A`:''}â€¢ SKU: ${p.id||'N/A'}%0A%0APlease advise delivery & payment options.`;
    const phone = '265996469902';
    const url = `https://wa.me/${phone}?text=${msg}`;
    window.open(url,'_blank','noopener');
    renderAdminOrders();
  }

  function onQuick(e){
    const p = JSON.parse(decodeURIComponent(e.currentTarget.getAttribute('data-quick')));
    const d = document.createElement('dialog');
    d.style.border='none'; d.style.padding='0'; d.style.background='transparent';
    d.innerHTML = `<form method="dialog" class="card" style="max-width:860px">
      <div style="display:grid;grid-template-columns:1fr .9fr">
        <img src="${p.img}" alt="${p.title}" style="width:100%;height:100%;object-fit:cover">
        <div class="pad">
          <h3 style="margin:0">${p.title}</h3>
          <div class="muted small">${p.cat} â€¢ ${p.size||''} â€¢ ${p.id||''}</div>
          <p class="muted" style="margin-top:8px">${p.notes||''}</p>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="primary" data-order='${encodeURIComponent(JSON.stringify(p))}'>Order on WhatsApp</button>
            <button value="cancel">Close</button>
          </div>
        </div>
      </div>
    </form>`;
    document.body.appendChild(d);
    d.showModal();
    d.querySelector('[data-order]').addEventListener('click', onOrder);
    d.addEventListener('close', ()=> d.remove());
  }

  /* ---------- Admin: Authentication (local password hashed) ---------- */
  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function setOrLogin(){
    const val = $('#adminPass').value.trim();
    if(!val){ toast('Enter a password'); return; }
    const stored = localStorage.getItem(passKey);
    const h = await sha256(val);
    if(!stored){
      localStorage.setItem(passKey,h);
      $('#adminPass').value='';
      toast('Password set â€” you are now logged in (local).');
      enterAdmin();
    } else {
      if(h === stored){ $('#adminPass').value=''; toast('Logged in as admin.'); enterAdmin(); }
      else toast('Incorrect password');
    }
  }
  $('#btnSetPass').addEventListener('click', async (ev)=>{ ev.preventDefault(); await setOrLogin(); });

  // log out
  function logoutAdmin(){ localStorage.removeItem('mbathe.admin.session'); // ephemeral flag
    $('#adminAuth').style.display='block'; $('#adminDash').style.display='none'; $('#adminControls').innerHTML=''; $('#adminBadge').innerHTML=''; toast('Admin logged out'); }

  /* ---------- Enter admin: show dashboard ---------- */
  function enterAdmin(){
    // simple session flag
    localStorage.setItem('mbathe.admin.session', '1');
    $('#adminAuth').style.display='none';
    $('#adminDash').style.display='block';
    $('#adminControls').innerHTML = `<button id="btnLogout">Logout</button>`;
    $('#adminBadge').innerHTML = `<span class="admin-flag">ADMIN</span>`;
    $('#btnLogout').addEventListener('click', logoutAdmin);
    renderAdminProducts();
    renderAdminOrders();
  }

  /* ---------- Admin dialog open ---------- */
  const adminDialog = $('#adminDialog');
  $('#btnAdmin').addEventListener('click', ()=> {
    const hasSession = localStorage.getItem('mbathe.admin.session');
    adminDialog.showModal();
    if(hasSession) enterAdmin(); else { $('#adminAuth').style.display='block'; $('#adminDash').style.display='none'; }
  });

  // close admin when clicking outside (optional)
  adminDialog.addEventListener('cancel', ()=> adminDialog.close());

  /* ---------- Admin: Products table ---------- */
  function renderAdminProducts(){
    catalog = loadProducts();
    const tbody = $('#adminProducts'); tbody.innerHTML = '';
    catalog.forEach((p, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.title}</td><td>${p.cat}</td><td>${money(p.price)}</td>
        <td><input type="checkbox" data-idx="${idx}" ${p.featured?'checked':''}></td>
        <td>
          <button data-edit="${p.id}">Edit</button>
          <button data-delete="${p.id}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    // bind
    $$('input[type=checkbox][data-idx]').forEach(cb=>{
      cb.addEventListener('change', e=>{
        const i = Number(e.currentTarget.getAttribute('data-idx'));
        catalog[i].featured = e.currentTarget.checked;
        saveProducts(catalog);
        renderProducts();
        renderAdminProducts();
      });
    });
    $$('[data-edit]').forEach(b=>b.addEventListener('click', e=> openProductEditor(e.currentTarget.getAttribute('data-edit'))));
    $$('[data-delete]').forEach(b=>b.addEventListener('click', e=>{
      if(!confirm('Delete this product?')) return;
      const id = e.currentTarget.getAttribute('data-delete');
      catalog = catalog.filter(x=>x.id !== id);
      saveProducts(catalog);
      renderProducts();
      renderAdminProducts();
      toast('Product deleted');
    }));
  }

  /* ---------- Admin: Product editor ---------- */
  const prodDialog = $('#productDialog');
  let editId = null;
  $('#btnNewProduct').addEventListener('click', ()=>{
    editId = null;
    $('#prodTitle').textContent = 'New Product';
    $('#fTitle').value = ''; $('#fCat').value='Men'; $('#fPrice').value=''; $('#fSize').value=''; $('#fNotes').value=''; $('#fImage').value='';
    $('#btnDeleteProd').style.display='none';
    prodDialog.showModal();
  });
  $('#btnCloseProd').addEventListener('click', ()=> prodDialog.close());

  async function openProductEditor(id){
    const p = catalog.find(x=>x.id===id);
    if(!p) return toast('Product not found');
    editId = id;
    $('#prodTitle').textContent = 'Edit Product';
    $('#fTitle').value = p.title; $('#fCat').value = p.cat; $('#fPrice').value = p.price; $('#fSize').value = p.size||''; $('#fNotes').value = p.notes||''; $('#fImage').value='';
    $('#btnDeleteProd').style.display='inline-block';
    prodDialog.showModal();
  }

  // save product (new or edit)
  $('#btnSaveProd').addEventListener('click', (ev)=>{
    ev.preventDefault();
    const title = $('#fTitle').value.trim();
    const cat = $('#fCat').value;
    const price = Number($('#fPrice').value)||0;
    const size = $('#fSize').value.trim();
    const notes = $('#fNotes').value.trim();
    const file = $('#fImage').files[0];

    if(!title || !price){ toast('Title and price required'); return; }

    const handleAdd = (imgUrl)=>{
      if(editId){
        // update
        const idx = catalog.findIndex(x=>x.id===editId);
        if(idx>-1){
          catalog[idx] = { ...catalog[idx], title, cat, price, size, notes, img: imgUrl || catalog[idx].img };
          saveProducts(catalog); renderProducts(); renderAdminProducts(); prodDialog.close(); toast('Product updated');
        }
      } else {
        const newItem = { id:'SKU-'+Math.floor(Math.random()*900000+1000), title, cat, price, size, notes, img: imgUrl||'https://images.unsplash.com/photo-1520975940479-6c0a72b44f9f?q=80&w=1600&auto=format&fit=crop', featured:false, created:Date.now() };
        catalog.unshift(newItem); saveProducts(catalog); renderProducts(); renderAdminProducts(); prodDialog.close(); toast('Product added');
      }
    };

    if(file){
      const r = new FileReader();
      r.onload = ()=> handleAdd(r.result);
      r.readAsDataURL(file);
    } else {
      handleAdd();
    }
  });

  // delete in editor
  $('#btnDeleteProd').addEventListener('click', (ev)=>{
    ev.preventDefault();
    if(!editId) return;
    if(!confirm('Delete this product?')) return;
    catalog = catalog.filter(x=>x.id !== editId);
    saveProducts(catalog); renderProducts(); renderAdminProducts(); prodDialog.close(); toast('Deleted');
  });

  /* ---------- Admin: Orders ---------- */
  function renderAdminOrders(){
    const orders = loadOrders();
    const tbody = $('#adminOrders'); tbody.innerHTML = '';
    orders.forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="white-space:nowrap">${new Date(o.when).toLocaleString()}</td>
                      <td>${o.item.title}</td>
                      <td>
                        <select data-ord='${o.id}'>
                          <option ${o.status==='Pending'?'selected':''}>Pending</option>
                          <option ${o.status==='Confirmed'?'selected':''}>Confirmed</option>
                          <option ${o.status==='Shipped'?'selected':''}>Shipped</option>
                          <option ${o.status==='Delivered'?'selected':''}>Delivered</option>
                          <option ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                      </td>`;
      tbody.appendChild(tr);
    });
    $$('select[data-ord]').forEach(s=>s.addEventListener('change', (e)=>{
      const id = e.currentTarget.getAttribute('data-ord');
      const list = loadOrders();
      const idx = list.findIndex(x=>x.id===id);
      if(idx>-1){ list[idx].status = e.currentTarget.value; saveOrders(list); renderAdminOrders(); toast('Order updated'); }
    }));
  }

  /* ---------- Admin Export / Import / Reset ---------- */
  $('#btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({products:catalog,orders:loadOrders()},null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='mbathe-export.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#btnImport').addEventListener('click', ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const data = JSON.parse(r.result);
        if(Array.isArray(data.products)) { catalog = data.products; saveProducts(catalog); }
        if(Array.isArray(data.orders)) { saveOrders(data.orders); }
        renderProducts(); renderAdminProducts(); renderAdminOrders(); toast('Import completed');
      }catch(err){ toast('Invalid file'); }
    };
    r.readAsText(f);
  });
  $('#btnResetSeed').addEventListener('click', ()=>{
    if(!confirm('Reset catalog to default seed? This overwrites local products.')) return;
    catalog = seed.slice(); saveProducts(catalog); renderProducts(); renderAdminProducts(); toast('Reset to seed');
  });

  /* ---------- Admin login state check on load ---------- */
  if(localStorage.getItem('mbathe.admin.session')) {
    // keep session active in UI badge
    $('#adminBadge').innerHTML = `<span class="admin-flag">ADMIN</span>`;
  }

  /* ---------- Local Add (non-admin) ---------- */
  $('#btnAddLocal').addEventListener('click', ()=> {
    // reuse productDialog as light-weight add? We'll open admin dialog if logged in, else prompt small add
    const sess = localStorage.getItem('mbathe.admin.session');
    if(sess){ // open product editor for quick add
      $('#btnNewProduct').click();
      if(!adminDialog.open) adminDialog.showModal();
      if(!prodDialog.open) prodDialog.showModal();
      return;
    }
    // simple prompt add
    const title = prompt('Product title');
    if(!title) return;
    const price = Number(prompt('Price (MWK)', '0'))||0;
    const cat = prompt('Category (Men/Women/Kids/Accessories)','Men');
    const item = { id:'SKU-'+Math.floor(Math.random()*900000+1000), title, cat, price, size:'', notes:'', img:'https://images.unsplash.com/photo-1520975940479-6c0a72b44f9f?q=80&w=1600&auto=format&fit=crop', featured:false, created:Date.now() };
    catalog.unshift(item); saveProducts(catalog); renderProducts(); toast('Added locally (no admin required)');
  });

  /* ---------- Initialize ---------- */
  // sort control default
  const s = document.createElement('option'); s.value='featured'; s.textContent='Featured'; s.selected=true;
  $('#sort').prepend(s);
  document.getElementById('year').textContent = new Date().getFullYear();

  // load initial
  renderProducts();

  // Admin rendering helpers
  function renderAdminOrders(){ renderAdminOrders = renderAdminOrdersInner; renderAdminOrdersInner(); } // forward declare
  function renderAdminOrdersInner(){ renderAdminOrdersInner = ()=>{} } // replaced after defined below
  // define actual function now:
  function renderAdminOrdersInner(){
    const tbl = $('#adminOrders'); tbl.innerHTML = '';
    const list = loadOrders();
    list.forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="white-space:nowrap">${new Date(o.when).toLocaleString()}</td><td>${o.item.title}</td><td>
        <select data-ord='${o.id}'><option ${o.status==='Pending'?'selected':''}>Pending</option><option ${o.status==='Confirmed'?'selected':''}>Confirmed</option><option ${o.status==='Shipped'?'selected':''}>Shipped</option><option ${o.status==='Delivered'?'selected':''}>Delivered</option><option ${o.status==='Cancelled'?'selected':''}>Cancelled</option></select>
      </td>`;
      tbl.appendChild(tr);
    });
    $$('select[data-ord]').forEach(s=>s.addEventListener('change', e=>{
      const id = e.currentTarget.getAttribute('data-ord'); const list = loadOrders(); const idx = list.findIndex(x=>x.id===id);
      if(idx>-1){ list[idx].status = e.currentTarget.value; saveOrders(list); toast('Order updated'); renderAdminOrdersInner(); }
    }));
  }
  // override the placeholder
  renderAdminOrders = renderAdminOrdersInner;

  // admin products renderer (actual)
  function renderAdminProducts(){ const tbody = $('#adminProducts'); tbody.innerHTML=''; catalog.forEach((p,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${p.title}</td><td>${p.cat}</td><td>${money(p.price)}</td><td><input type="checkbox" data-idx="${idx}" ${p.featured?'checked':''}></td><td><button data-edit="${p.id}">Edit</button> <button data-delete="${p.id}">Delete</button></td>`; tbody.appendChild(tr); }); $$('input[type=checkbox][data-idx]').forEach(cb=>cb.addEventListener('change', e=>{ const i=Number(e.currentTarget.getAttribute('data-idx')); catalog[i].featured = e.currentTarget.checked; saveProducts(catalog); renderProducts(); renderAdminProducts(); })); $$('[data-edit]').forEach(b=>b.addEventListener('click', e=> openProductEditor(e.currentTarget.getAttribute('data-edit')))); $$('[data-delete]').forEach(b=>b.addEventListener('click', e=>{ if(!confirm('Delete this product?')) return; const id=e.currentTarget.getAttribute('data-delete'); catalog = catalog.filter(x=>x.id!==id); saveProducts(catalog); renderProducts(); renderAdminProducts(); toast('Deleted'); })); }

  // if session exists, show admin UI when opening dialog:
  adminDialog.addEventListener('close', ()=>{ /* nothing */ });

  // Prefill admin password field to empty
  $('#adminPass').value='';

  // if password exists but no session, keep adminAuth visible when opening
  // provide quick login by pressing Enter
  $('#adminPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSetPass').click(); } });

  // create initial storage if absent
  if(!localStorage.getItem(storeKey)) saveProducts(seed.slice());

  // render immediately
  renderProducts();

  // small UX: close dialogs on Escape handled by browser by default
  </script>
</body>
</html>